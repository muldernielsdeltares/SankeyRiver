function E(n,l){let t=new Set(n.keys()),i=0;for(;t.size;){let e=[];for(let r of t)n.get(r).in.map(f=>f.from).every(f=>n.get(f).x!==void 0)&&e.push(r);for(let r of e){let d=n.get(r);d.x=d.column||i,t.delete(r)}i++}let o=i-1,a=[...n.keys()],s=new Set(l.map(e=>e.from));return a.filter(e=>!s.has(e)).forEach(e=>{let r=n.get(e);r.x=r.column||o,o=Math.max(o,r.x)}),o}function z(n,l,t){let i=0,o=[...n.values()].sort((a,s)=>(a.sorting??0)-(s.sorting??0));for(let a=0;a<=l;a++){let s=0,e=o.filter(r=>r.x===a);for(let r of e){let d=r.relativeTo?.id,u=d?n.get(d):null;(!u||typeof u.y>"u")&&(u=null),u?r.y=u.y+(r.relativeTo.y1??0)*u.size+(r.relativeTo.y2??0)*r.size:r.y=s,s=r.y+r.size}i=Math.max(s,i)}return i}function M(n){for(let l of n.values()){let t=0;l.in.sort((i,o)=>n.get(i.from).y-n.get(o.from).y).forEach((i,o)=>{i.yOffsetTo=t,t+=i.value}),t=0,l.out.sort((i,o)=>n.get(i.to).y-n.get(o.to).y).forEach((i,o)=>{i.yOffsetFrom=t,t+=i.value})}}function F(n,l,t){let i=0,o=0,a=[...n.values()].sort((s,e)=>s.y-e.y);for(let s=0;s<=t;s++){let e=0,r=a.filter(d=>d.x===s);for(let d of r)d.relativeTo&&(e=0),d.paddings&&(e=d.paddings),d.y+=e*l,e+=1,i=Math.max(i,d.y+d.size),o=Math.min(o,d.y)}if(o<0)for(let s of n.values())s.y-=o;return i-o}function L(n,l,t){let i=new Map;for(let o of n.values()){let a=o.x;i.set(a,Math.max(i.get(a)??0,o.width));let s=o.label.position;if(o.label.position||(s=a===0?"left":a===t?"right":"center",o.label.position=s),a===0&&s!=="right"){let e=s==="center"?o.label.width*.5-o.width/2:o.label.width;l.labelSpaceLeft=Math.max(l.labelSpaceLeft??0,e)}else if(a===t&&s!=="left"){let e=s==="center"?o.label.width*.5-o.width/2:o.label.width;l.labelSpaceRight=Math.max(l.labelSpaceRight??0,e)}}return i}function B(n){return`rect[id^='node-']{fill:#777}
path[id^='flow-']{opacity:0.6;fill:#ddd;&:hover{opacity:1}}
path.flowvalue-zero{stroke:#ddd;stroke-width:1}
g[id^='label-node']{pointer-events:none;rect{fill:#fff}}
*{font-size:${n.fontsize}pt}`}function Y(n,l){let t="";for(let i of n.values()){let o=T(i.style);o&&(t+=`#node-${i.idClean} { ${o} }
`)}for(let i of l){let o=T(i.style);o&&(t+=`#flow-${i.idClean} { ${o} }
`)}return t}function T(n){if(n)return Object.entries(n).map(([l,t])=>`${l}:${t};`).join(" ")}function v(n,l,t,i){let o=n.get(l.from),a=n.get(l.to),s=l.value/2,e=s*i,r=o.y_+(s+l.yOffsetFrom)*i,d=a.y_+(s+l.yOffsetTo)*i,u=o.x_+o.width,f=a.x_;return l.render==="b"?Q(f,d,u,r,e):U({x:u,y:r},{x:u+t/2,y:r},{x:f-t/2,y:d},{x:f,y:d},e)}function Q(n,l,t,i,o){let s=(t-n)/3,e={x:n,y:l-o},r={x:t,y:i-o},d={x:t,y:i+o},u={x:n,y:l+o},f={x:n+s,y:e.y},m={x:t-s,y:r.y},c={x:m.x,y:d.y},h={x:f.x,y:u.y};return`M ${e.x},${e.y}C ${f.x},${f.y} ${m.x},${m.y} ${r.x},${r.y}L ${d.x},${d.y}C ${c.x},${c.y} ${h.x},${h.y} ${u.x},${u.y}Z`}function U(n,l,t,i,o,a=30){let s=[],e=[];for(let d=0;d<=a;d++){let u=d/a,f=tt(u,n,l,t,i),m=et(u,n,l,t,i);s.push(X(f,m,o)),e.unshift(X(f,m,-o))}let r=[];r.push(`M ${s[0].x},${s[0].y}`);for(let d=1;d<s.length;d++)r.push(`L ${s[d].x},${s[d].y}`);for(let d=0;d<e.length;d++)r.push(`L ${e[d].x},${e[d].y}`);return r.push("Z"),r.join(" ")}function tt(n,l,t,i,o){let a=1-n;return{x:a**3*l.x+3*a**2*n*t.x+3*a*n**2*i.x+n**3*o.x,y:a**3*l.y+3*a**2*n*t.y+3*a*n**2*i.y+n**3*o.y}}function et(n,l,t,i,o){let a=1-n,s={x:3*a**2*(t.x-l.x)+6*a*n*(i.x-t.x)+3*n**2*(o.x-i.x),y:3*a**2*(t.y-l.y)+6*a*n*(i.y-t.y)+3*n**2*(o.y-i.y)},e={x:-s.y,y:s.x},r=Math.sqrt(e.x*e.x+e.y*e.y);return r===0?{x:0,y:0}:{x:e.x/r,y:e.y/r}}function X(n,l,t){return{x:n.x+l.x*t,y:n.y+l.y*t}}var A="http://www.w3.org/2000/svg",p=(n,l)=>{let t=document.createElementNS(A,n);return Object.entries(l).forEach(([i,o])=>{o&&t.setAttribute(i,String(o))}),t};function G(n,l,t){let i=p("svg",{width:l,height:t,id:n.id}),o=p("g",{id:"nodes"});i.appendChild(o);let a=p("g",{id:"flows"});i.appendChild(a);let s=p("g",{id:"labels"});return i.appendChild(s),{svg:i,groupNodes:o,groupFlows:a,groupLabels:s}}function V(n,l,t,i){for(let o of l.values()){if(!o.label.text){o.label.width=0,o.label.height=0;continue}let a=[`label-column-${o.x}`];o.x===i?a.push("label-column-last"):o.x!==0&&a.push("label-column-middle");let s=p("g",{id:`label-node-${o.idClean}`,class:a.join(" ")});n.appendChild(s);let e=p("text",{"font-size":`${t.fontsize}pt`});if(s.appendChild(e),typeof o.label.text=="string"){let u=o.label.text.split(`
`);for(let f of u){let m=p("tspan",{x:t.labelPadding,dy:"1.2em","font-size":`${t.fontsize}pt`});m.textContent=f,e.appendChild(m)}}let r=e.getBBox();o.label.width=r.width+2*t.labelPadding,o.label.height=r.height+2*t.labelPadding;let d=p("rect",{width:o.label.width,height:o.label.height,"font-size":`${t.fontsize}pt`});s.insertBefore(d,e)}}function _(n,l,t,i){let o=document.createElementNS(A,"style");o.textContent=`svg#${i.id}{
${B(i)}
${Y(l,t)}}`,n.appendChild(o)}function k(n,l,t,i,o,a,s,e){let r=t.labelSpaceLeft+t.labelSpaceRight,d=(i-r-e.get(a)-t.margin[1]-t.margin[3])/a,u=(o-t.margin[0]-t.margin[2])/s;t.scaleX=d,t.scaleY=u;for(let f of n.values()){let m=f.x===0?0:(e.get(f.x)-f.width)/(f.x===a?1:2);f.x_=f.x*d+t.labelSpaceLeft+m+t.margin[1],f.y_=f.y*u+t.margin[0],f.size_=f.size*u}}function I(n,l,t,i,o,a,s,e,r,d,u=!1){u&&(l.innerHTML="",t.innerHTML="");let f=a.scaleX,m=a.scaleY;for(let c of i.values()){if(c.width>0&&c.size_>0){let J=typeof c.tooltip=="function"?c.tooltip(c):c.tooltip===null?null:c.tooltip||`${c.label.text||""} (${c.size})`,K=p("rect",{id:`node-${c.idClean}`,x:c.x_,y:c.y_,width:c.width,height:c.size_,class:c.className||"","data-tooltip":J});l.appendChild(K)}let h=document.getElementById(`label-node-${c.idClean}`);if(!h)continue;let $=c.y_+c.size_/2-c.label.height/2-a.fontsize*.3,x;c.label.position==="left"?x=c.x_-c.label.width:c.label.position==="right"?x=c.x_+c.width:x=c.x_+c.width/2-c.label.width/2,h.setAttribute("transform",`translate(${x}, ${$})`)}for(let c of o){let h=[c.className];c.value===0&&h.push("flowvalue-zero");let $=typeof c.tooltip=="function"?c.tooltip(c):c.tooltip===null?null:c.tooltip||`${i.get(c.from).label.text} &rarr; ${i.get(c.to).label.text}: ${c.value}`,x=p("path",{id:`flow-${c.idClean}`,class:h.join(" "),d:v(i,c,f,m),"data-tooltip":$});t.appendChild(x)}}var C="";function R(n,l,t){let i=document.createElement("div");C=`${n}-tooltip`,i.setAttribute("id",C),i.setAttribute("style",`font-size:${t.fontsize}pt;background:#000;border-radius:5px;padding:5px;color:#fff;position:absolute;display:none;`),l.parentNode.insertBefore(i,l),document.getElementById("tooltip")}function O(){document.querySelectorAll("[data-tooltip]").forEach(n=>{let l=n.getAttribute("data-tooltip");n.addEventListener("mousemove",ot(l)),n.addEventListener("mouseout",nt())})}function j(){return document.getElementById(C)}function ot(n){return l=>{if(!n)return;let t=j();t.innerHTML=n,t.style.display="block",t.style.left=l.pageX+10+"px",t.style.top=l.pageY+10+"px"}}function nt(){return function(n){let l=j();l.style.display="none"}}var N=n=>n.replaceAll(/[^\w\d]+/g,"");function H(n){let{flows:l,nodeConfig:t={},nodeBaseConfig:i={},flowBaseConfig:o={}}=n,a=new Set;l.forEach(e=>{Object.assign(e,o,e),e.value=Number(e.value||0),e.idClean=`${N(e.from)}-${N(e.to)}`,a.add(e.from),a.add(e.to)});let s=new Map;for(let e of a){let r={id:e,idClean:N(e),in:[],out:[],...i,...t[e],label:{...i?.label,...t[e]?.label}};s.set(e,r)}for(let e of l)s.get(e.from).out.push(e),s.get(e.to).in.push(e);for(let e of s.values())e.size=Math.max(e.in.reduce((r,d)=>r+d.value,0),e.out.reduce((r,d)=>r+d.value,0)),e.label.text=typeof e.label.text=="function"?e.label.text(e):e.label.text===null?null:e.label.text||e.id;return{nodes:s,flows:l}}var g,y=null,b,W=[],w,S,P,q=n=>{let l=g.createSVGPoint();l.x=n.clientX,l.y=n.clientY;let t=l.matrixTransform(g.getScreenCTM()?.inverse());return{x:t.x,y:t.y}};function D(n,l,t,i,o){g=n;let a=g.querySelectorAll("rect[id^='node-']");for(let s of a)s.addEventListener("mousedown",e=>{e.preventDefault(),y=s;let r=q(e),d=Number(s.getAttribute("x")),u=Number(s.getAttribute("y"));S={x:r.x-d,y:r.y-u};let f=y.getAttribute("id");if(w=[...l.values()].find(m=>m.idClean===f.replace("node-","")),b=g.getElementById(`label-${f}`),b){let m=b.getAttribute("transform").slice(10,-1).split(",").map(parseFloat);P={x:r.x-m[0],y:r.y-m[1]}}for(let m of w.in.concat(w.out)){let c=g.getElementById(`flow-${m.idClean}`);c&&(W.push({element:g.getElementById(`flow-${m.idClean}`),flow:m}),o.appendChild(c))}});document.addEventListener("mousemove",s=>{if(!y)return;let{x:e,y:r}=q(s);w.x_=e-S.x,w.y_=r-S.y,y.setAttribute("x",String(e-S.x)),y.setAttribute("y",String(r-S.y)),b&&b.setAttribute("transform",`translate(${e-P.x}, ${r-P.y})`);for(let d of W)d.element.setAttribute("d",v(l,d.flow,t,i))}),document.addEventListener("mouseup",()=>{y=null})}var Z=class{constructor(l,t){this.containerId=l;this.config=t;this.config.id=this.config.id??`${l}_`,this.config.padding??=20,this.config.labelPadding??=4,this.config.fontsize??=12,this.config.labelSpaceLeft??=0,this.config.labelSpaceRight??=0,this.config.margin??=[0,0,0,0],this.config.nodeBaseConfig??={},this.config.nodeBaseConfig.width??=20,this.config.flowBaseConfig??={},this.config.flowBaseConfig.render??="b",this.container=document.getElementById(l),this.container.innerHTML="",this.height=this.container.offsetHeight||500,this.width=this.container.offsetWidth||500;let{svg:i,groupNodes:o,groupFlows:a,groupLabels:s}=G(this.config,this.width,this.height);this.container.appendChild(i),R(l,this.container,this.config);let{nodes:e,flows:r}=H(this.config);this.nodes=e,this.flows=r,this.maxX=E(this.nodes,this.flows),this.maxY=z(this.nodes,this.maxX,this.config);let d=this.maxY/this.height*this.config.padding;this.maxY=F(this.nodes,d,this.maxX),M(this.nodes),V(s,this.nodes,this.config,this.maxX),this.maxNodeWidth=L(this.nodes,this.config,this.maxX),_(i,this.nodes,this.flows,this.config),k(this.nodes,this.flows,this.config,this.width,this.height,this.maxX,this.maxY,this.maxNodeWidth),I(i,o,a,this.nodes,this.flows,this.config,this.width,this.height,this.maxX,this.maxY),O(),D(i,this.nodes,t.scaleX,t.scaleY,a)}};export{Z as Sankey};
