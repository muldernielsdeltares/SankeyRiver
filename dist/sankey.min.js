function F(t,s){let o=new Set(t.keys()),i=0;for(;o.size;){let e=[];for(let d of o)t.get(d).in.map(f=>f.from).every(f=>t.get(f).x!==void 0)&&e.push(d);for(let d of e){let a=t.get(d);a.x=a.column||i,o.delete(d)}i++}let n=i-1,r=[...t.keys()],l=new Set(s.map(e=>e.from));return r.filter(e=>!l.has(e)).forEach(e=>{let d=t.get(e);d.x=d.column||n,n=Math.max(n,d.x)}),n}function G(t,s){let o=0,i=[...t.values()].sort((n,r)=>(n.sorting??0)-(r.sorting??0));for(let n=0;n<=s;n++){let r=0,l=i.filter(e=>e.x===n);for(let e of l){let d=e.relativeTo?.id,a=d?t.get(d):null;(!a||typeof a.y>"u")&&(a=null),a&&e.relativeTo?e.y=a.y+(e.relativeTo.y1??0)*a.size+(e.relativeTo.y2??0)*e.size:e.y=r,r=e.y+e.size}o=Math.max(r,o)}return o}function M(t){for(let s of t.values()){let o=0;s.in.sort((i,n)=>t.get(i.from).y-t.get(n.from).y).forEach(i=>{i.yOffsetTo=o,o+=i.value}),o=0,s.out.sort((i,n)=>t.get(i.to).y-t.get(n.to).y).forEach(i=>{i.yOffsetFrom=o,o+=i.value})}}function L(t,s,o){let i=0,n=0,r=[...t.values()].sort((l,e)=>l.y-e.y);for(let l=0;l<=o;l++){let e=0,d=r.filter(a=>a.x===l);for(let a of d)a.relativeTo&&(e=0),a.paddings&&(e=a.paddings),a.y+=e*s,e+=1,i=Math.max(i,a.y+a.size),n=Math.min(n,a.y)}if(n<0)for(let l of t.values())l.y-=n;return i-n}function V(t,s,o){let i=new Map;for(let n of t.values()){let r=n.x;i.set(r,Math.max(i.get(r)??0,n.width));let l=n.label.position;if(n.label.position||(l=r===0?"left":r===o?"right":"center",n.label.position=l),r===0&&l!=="right"){let e=l==="center"?n.label.width*.5-n.width/2:n.label.width;s.labelSpaceLeft=Math.max(s.labelSpaceLeft??0,e)}else if(r===o&&l!=="left"){let e=l==="center"?n.label.width*.5-n.width/2:n.label.width;s.labelSpaceRight=Math.max(s.labelSpaceRight??0,e)}}return i}function Y(t){return`rect[id^='node-']{fill:#777}
path[id^='flow-']{opacity:0.6;fill:#ddd;&:hover{opacity:1}}
path.flowvalue-zero{stroke:#ddd;stroke-width:1}
g[id^='label-node']{pointer-events:none;rect{fill:#fff}}
*{font-size:${t.fontsize}pt}`}function B(t,s){let o="";for(let i of t.values()){let n=T(i.style);n&&(o+=`#node-${i.idClean} { ${n} }
`)}for(let i of s){let n=T(i.style);n&&(o+=`#flow-${i.idClean} { ${n} }
`)}return o}function T(t){if(t)return Object.entries(t).map(([s,o])=>`${s}:${o};`).join(" ")}function $(t,s,o,i){let n=t.get(s.from),r=t.get(s.to),l=s.value/2,e=l*i,d=n.y_+(l+s.yOffsetFrom)*i,a=r.y_+(l+s.yOffsetTo)*i,m=n.x_+n.width,f=r.x_;return s.render==="b"?tt(f,a,m,d,e):et({x:m,y:d},{x:m+o/2,y:d},{x:f-o/2,y:a},{x:f,y:a},e)}function tt(t,s,o,i,n){let l=(o-t)/3,e={x:t,y:s-n},d={x:o,y:i-n},a={x:o,y:i+n},m={x:t,y:s+n},f={x:t+l,y:e.y},u={x:o-l,y:d.y},c={x:u.x,y:a.y},g={x:f.x,y:m.y};return`M ${e.x},${e.y}C ${f.x},${f.y} ${u.x},${u.y} ${d.x},${d.y}L ${a.x},${a.y}C ${c.x},${c.y} ${g.x},${g.y} ${m.x},${m.y}Z`}function et(t,s,o,i,n,r=30){let l=[],e=[];for(let a=0;a<=r;a++){let m=a/r,f=ot(m,t,s,o,i),u=nt(m,t,s,o,i);l.push(X(f,u,n)),e.unshift(X(f,u,-n))}let d=[];d.push(`M ${l[0].x},${l[0].y}`);for(let a=1;a<l.length;a++)d.push(`L ${l[a].x},${l[a].y}`);for(let a=0;a<e.length;a++)d.push(`L ${e[a].x},${e[a].y}`);return d.push("Z"),d.join(" ")}function ot(t,s,o,i,n){let r=1-t;return{x:r**3*s.x+3*r**2*t*o.x+3*r*t**2*i.x+t**3*n.x,y:r**3*s.y+3*r**2*t*o.y+3*r*t**2*i.y+t**3*n.y}}function nt(t,s,o,i,n){let r=1-t,l={x:3*r**2*(o.x-s.x)+6*r*t*(i.x-o.x)+3*t**2*(n.x-i.x),y:3*r**2*(o.y-s.y)+6*r*t*(i.y-o.y)+3*t**2*(n.y-i.y)},e={x:-l.y,y:l.x},d=Math.sqrt(e.x*e.x+e.y*e.y);return d===0?{x:0,y:0}:{x:e.x/d,y:e.y/d}}function X(t,s,o){return{x:t.x+s.x*o,y:t.y+s.y*o}}var k="http://www.w3.org/2000/svg",p=(t,s)=>{let o=document.createElementNS(k,t);return Object.entries(s).forEach(([i,n])=>{n&&o.setAttribute(i,String(n))}),o};function A(t,s,o){let i=p("svg",{width:s,height:o,id:t.id}),n=p("g",{id:"nodes"});i.appendChild(n);let r=p("g",{id:"flows"});i.appendChild(r);let l=p("g",{id:"labels"});return i.appendChild(l),{svg:i,groupNodes:n,groupFlows:r,groupLabels:l}}function _(t,s,o,i){for(let n of s.values()){if(!n.label.text){n.label.width=0,n.label.height=0;continue}let r=p("g",{id:`label-node-${n.idClean}`,class:H(n,i,"label")});t.appendChild(r);let l=p("text",{"font-size":`${o.fontsize}pt`});if(r.appendChild(l),typeof n.label.text=="string"){let a=n.label.text.split(`
`);for(let m of a){let f=p("tspan",{x:o.labelPadding,dy:"1.2em","font-size":`${o.fontsize}pt`});f.textContent=m,l.appendChild(f)}}let e=l.getBBox();n.label.width=e.width+2*o.labelPadding,n.label.height=e.height+2*o.labelPadding;let d=p("rect",{width:n.label.width,height:n.label.height,"font-size":`${o.fontsize}pt`});r.insertBefore(d,l)}}function R(t,s,o,i){let n=document.createElementNS(k,"style");n.textContent=`svg#${i.id}{
${Y(i)}
${B(s,o)}}`,t.appendChild(n)}function I(t,s,o,i,n,r,l,e){let d=o.labelSpaceLeft+o.labelSpaceRight,a=(i-d-e.get(r)-o.margin[1]-o.margin[3])/r,m=(n-o.margin[0]-o.margin[2])/l;o.scaleX=a,o.scaleY=m;for(let f of t.values()){let u=f.x===0?0:(e.get(f.x)-f.width)/(f.x===r?1:2);f.x_=f.x*a+o.labelSpaceLeft+u+o.margin[1],f.y_=f.y*m+o.margin[0],f.size_=f.size*m}}function O(t,s,o,i,n,r,l,e,d,a,m=!1){m&&(s.innerHTML="",o.innerHTML="");let f=r.scaleX,u=r.scaleY;for(let c of i.values()){if(c.width>0&&c.size_>0){let Q=typeof c.tooltip=="function"?c.tooltip(c):c.tooltip===null?null:c.tooltip||`${c.label.text||""} (${c.size})`,U=p("rect",{id:`node-${c.idClean}`,x:c.x_,y:c.y_,width:c.width,height:c.size_,class:H(c,d,"node",c.className),"data-tooltip":Q});s.appendChild(U)}let g=t.getElementById(`label-node-${c.idClean}`);if(!g)continue;let v=c.y_+c.size_/2-c.label.height/2-r.fontsize*.3,x;c.label.position==="left"?x=c.x_-c.label.width:c.label.position==="right"?x=c.x_+c.width:x=c.x_+c.width/2-c.label.width/2,g.setAttribute("transform",`translate(${x}, ${v})`)}for(let c of n){let g=[c.className];c.value===0&&g.push("flowvalue-zero");let v=typeof c.tooltip=="function"?c.tooltip(c):c.tooltip===null?null:c.tooltip||`${i.get(c.from).label.text} &rarr; ${i.get(c.to).label.text}: ${c.value}`,x=p("path",{id:`flow-${c.idClean}`,class:g.join(" "),d:$(i,c,f,u),"data-tooltip":v});o.appendChild(x)}}function H(t,s,o,i=null){let n=[`${o}-column-${t.x}`];return t.x===s?n.push(`${o}-column-last`):t.x!==0&&n.push(`${o}-column-middle`),i&&n.push(i),n.join(" ")}var N="",y,it=window.innerWidth,st=window.innerHeight;function j(t,s){let o=document.createElement("div");N=`${t}-tooltip`,o.setAttribute("id",N),o.setAttribute("style",`font-size:${s.fontsize}pt;background:#000;border-radius:5px;padding:5px;color:#fff;position:absolute;display:none;`),document.body.appendChild(o)}function W(){document.querySelectorAll("[data-tooltip]").forEach(t=>{let s=t.getAttribute("data-tooltip");s&&(t.addEventListener("mouseenter",lt(s)),t.addEventListener("mousemove",rt()),t.addEventListener("mouseleave",at()))})}function E(){return document.getElementById(N)}function lt(t){return()=>{let s=E();s.innerHTML=t,s.style.display="block",y=s.getBoundingClientRect()}}function rt(){return t=>{let s=E();y=s.getBoundingClientRect();let o=t.clientX+window.scrollX+10,i=t.clientY+window.scrollY+10;t.clientX+y.width+20>it&&(o=t.clientX+window.scrollX-y.width-10),t.clientY+y.height+20>st&&(i=t.clientY+window.scrollY-y.height-10),s.style.left=o+"px",s.style.top=i+"px"}}function at(){return function(){let t=E();t.style.display="none"}}var P=t=>t.replaceAll(/[^\w\d]+/g,"");function D(t){let{flows:s,nodeConfig:o={},nodeBaseConfig:i={},flowBaseConfig:n={}}=t,r=new Set;s.forEach(e=>{Object.assign(e,n,e),e.value=Number(e.value||0),e.idClean=`${P(e.from)}-${P(e.to)}`,r.add(e.from),r.add(e.to)});let l=new Map;for(let e of r){let d={id:e,idClean:P(e),in:[],out:[],...i,...o[e],label:{...i?.label,...o[e]?.label}};l.set(e,d)}for(let e of s)l.get(e.from).out.push(e),l.get(e.to).in.push(e);for(let e of l.values())e.size=Math.max(e.in.reduce((d,a)=>d+a.value,0),e.out.reduce((d,a)=>d+a.value,0)),e.label.text=typeof e.label.text=="function"?e.label.text(e):e.label.text===null?null:e.label.text||e.id;return{nodes:l,flows:s}}var h,b=null,w,q=[],S,C,z,Z=t=>{let s=h.createSVGPoint();s.x=t.clientX,s.y=t.clientY;let o=s.matrixTransform(h.getScreenCTM()?.inverse());return{x:o.x,y:o.y}};function J(t,s,o,i,n){h=t;let r=h.querySelectorAll("rect[id^='node-']");for(let l of r)l.addEventListener("mousedown",e=>{e.preventDefault(),b=l;let d=Z(e),a=Number(l.getAttribute("x")),m=Number(l.getAttribute("y"));C={x:d.x-a,y:d.y-m};let f=b.getAttribute("id");if(S=[...s.values()].find(u=>u.idClean===f.replace("node-","")),w=h.getElementById(`label-${f}`),w){let u=w.getAttribute("transform").slice(10,-1).split(",").map(parseFloat);z={x:d.x-u[0],y:d.y-u[1]}}for(let u of S.in.concat(S.out)){let c=h.getElementById(`flow-${u.idClean}`);c&&(q.push({element:h.getElementById(`flow-${u.idClean}`),flow:u}),n.appendChild(c))}});document.addEventListener("mousemove",l=>{if(!b)return;let{x:e,y:d}=Z(l);S.x_=e-C.x,S.y_=d-C.y,b.setAttribute("x",String(e-C.x)),b.setAttribute("y",String(d-C.y)),w&&w.setAttribute("transform",`translate(${e-z.x}, ${d-z.y})`);for(let a of q)a.element.setAttribute("d",$(s,a.flow,o,i))}),document.addEventListener("mouseup",()=>{b=null})}var K=class{constructor(s,o){this.containerId=s;this.config=o;this.config.id=this.config.id??`${s}_`,this.config.padding??=20,this.config.labelPadding??=4,this.config.fontsize??=12,this.config.labelSpaceLeft??=0,this.config.labelSpaceRight??=0,this.config.margin??=[0,0,0,0],this.config.nodeBaseConfig??={},this.config.nodeBaseConfig.width??=20,this.config.flowBaseConfig??={},this.config.flowBaseConfig.render??="b",this.container=document.getElementById(s),this.container.innerHTML="",this.height=this.container.offsetHeight||500,this.width=this.container.offsetWidth||500;let{svg:i,groupNodes:n,groupFlows:r,groupLabels:l}=A(this.config,this.width,this.height);this.container.appendChild(i),j(s,this.config);let{nodes:e,flows:d}=D(this.config);this.nodes=e,this.flows=d,this.maxX=F(this.nodes,this.flows),this.maxY=G(this.nodes,this.maxX,this.config);let a=this.maxY/this.height*this.config.padding;this.maxY=L(this.nodes,a,this.maxX),M(this.nodes),_(l,this.nodes,this.config,this.maxX),this.maxNodeWidth=V(this.nodes,this.config,this.maxX),R(i,this.nodes,this.flows,this.config),I(this.nodes,this.flows,this.config,this.width,this.height,this.maxX,this.maxY,this.maxNodeWidth),O(i,n,r,this.nodes,this.flows,this.config,this.width,this.height,this.maxX,this.maxY),W(),J(i,this.nodes,o.scaleX,o.scaleY,r)}};export{K as Sankey};
