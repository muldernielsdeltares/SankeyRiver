function M(t,l){let e=new Set(t.keys()),i=0;for(;e.size;){let n=[];for(let r of e)t.get(r).in.map(f=>f.from).every(f=>t.get(f).x!==void 0)&&n.push(r);for(let r of n){let d=t.get(r);d.x=d.column||i,e.delete(r)}i++}let o=i-1,a=[...t.keys()],s=new Set(l.map(n=>n.from));return a.filter(n=>!s.has(n)).forEach(n=>{let r=t.get(n);r.x=r.column||o,o=Math.max(o,r.x)}),o}function F(t,l,e){let i=0,o=[...t.values()].sort((a,s)=>(a.sorting??0)-(s.sorting??0));for(let a=0;a<=l;a++){let s=0,n=o.filter(r=>r.x===a);for(let r of n){let d=r.relativeTo?.id,u=d?t.get(d):null;(!u||typeof u.y>"u")&&(u=null),u?r.y=u.y+(r.relativeTo.y1??0)*u.size+(r.relativeTo.y2??0)*r.size:r.y=s,s=r.y+r.size}i=Math.max(s,i)}return i}function L(t){for(let l of t.values()){let e=0;l.in.sort((i,o)=>t.get(i.from).y-t.get(o.from).y).forEach((i,o)=>{i.yOffsetTo=e,e+=i.value}),e=0,l.out.sort((i,o)=>t.get(i.to).y-t.get(o.to).y).forEach((i,o)=>{i.yOffsetFrom=e,e+=i.value})}}function Y(t,l,e){let i=0,o=0,a=[...t.values()].sort((s,n)=>s.y-n.y);for(let s=0;s<=e;s++){let n=0,r=a.filter(d=>d.x===s);for(let d of r)d.relativeTo&&(n=0),d.paddings&&(n=d.paddings),d.y+=n*l,n+=1,i=Math.max(i,d.y+d.size),o=Math.min(o,d.y)}if(o<0)for(let s of t.values())s.y-=o;return i-o}function T(t,l,e){let i=new Map;for(let o of t.values()){let a=o.x;i.set(a,Math.max(i.get(a)??0,o.width));let s=o.label.position;if(o.label.position||(s=a===0?"left":a===e?"right":"center",o.label.position=s),a===0&&s!=="right"){let n=s==="center"?o.label.width*.5-o.width/2:o.label.width;l.labelSpaceLeft=Math.max(l.labelSpaceLeft??0,n)}else if(a===e&&s!=="left"){let n=s==="center"?o.label.width*.5-o.width/2:o.label.width;l.labelSpaceRight=Math.max(l.labelSpaceRight??0,n)}}return i}function X(t){return`rect[id^='node-']{fill:#777}
path[id^='flow-']{opacity:0.6;fill:#ddd;&:hover{opacity:1}}
path.flowvalue-zero{stroke:#ddd;stroke-width:1}
g[id^='label-node']{pointer-events:none;rect{fill:#fff}}
*{font-size:${t.fontsize}pt}`}function A(t,l){let e="";for(let i of t.values()){let o=B(i.style);o&&(e+=`#node-${i.idClean} { ${o} }
`)}for(let i of l){let o=B(i.style);o&&(e+=`#flow-${i.idClean} { ${o} }
`)}return e}function B(t){if(t)return Object.entries(t).map(([l,e])=>`${l}:${e};`).join(" ")}function v(t,l,e,i){let o=t.get(l.from),a=t.get(l.to),s=l.value/2,n=s*i,r=o.y_+(s+l.yOffsetFrom)*i,d=a.y_+(s+l.yOffsetTo)*i,u=o.x_+o.width,f=a.x_;return l.render==="b"?tt(f,d,u,r,n):et({x:u,y:r},{x:u+e/2,y:r},{x:f-e/2,y:d},{x:f,y:d},n)}function tt(t,l,e,i,o){let s=(e-t)/3,n={x:t,y:l-o},r={x:e,y:i-o},d={x:e,y:i+o},u={x:t,y:l+o},f={x:t+s,y:n.y},m={x:e-s,y:r.y},c={x:m.x,y:d.y},p={x:f.x,y:u.y};return`M ${n.x},${n.y}C ${f.x},${f.y} ${m.x},${m.y} ${r.x},${r.y}L ${d.x},${d.y}C ${c.x},${c.y} ${p.x},${p.y} ${u.x},${u.y}Z`}function et(t,l,e,i,o,a=30){let s=[],n=[];for(let d=0;d<=a;d++){let u=d/a,f=ot(u,t,l,e,i),m=nt(u,t,l,e,i);s.push(G(f,m,o)),n.unshift(G(f,m,-o))}let r=[];r.push(`M ${s[0].x},${s[0].y}`);for(let d=1;d<s.length;d++)r.push(`L ${s[d].x},${s[d].y}`);for(let d=0;d<n.length;d++)r.push(`L ${n[d].x},${n[d].y}`);return r.push("Z"),r.join(" ")}function ot(t,l,e,i,o){let a=1-t;return{x:a**3*l.x+3*a**2*t*e.x+3*a*t**2*i.x+t**3*o.x,y:a**3*l.y+3*a**2*t*e.y+3*a*t**2*i.y+t**3*o.y}}function nt(t,l,e,i,o){let a=1-t,s={x:3*a**2*(e.x-l.x)+6*a*t*(i.x-e.x)+3*t**2*(o.x-i.x),y:3*a**2*(e.y-l.y)+6*a*t*(i.y-e.y)+3*t**2*(o.y-i.y)},n={x:-s.y,y:s.x},r=Math.sqrt(n.x*n.x+n.y*n.y);return r===0?{x:0,y:0}:{x:n.x/r,y:n.y/r}}function G(t,l,e){return{x:t.x+l.x*e,y:t.y+l.y*e}}var V="http://www.w3.org/2000/svg",h=(t,l)=>{let e=document.createElementNS(V,t);return Object.entries(l).forEach(([i,o])=>{o&&e.setAttribute(i,String(o))}),e};function _(t,l,e){let i=h("svg",{width:l,height:e,id:t.id}),o=h("g",{id:"nodes"});i.appendChild(o);let a=h("g",{id:"flows"});i.appendChild(a);let s=h("g",{id:"labels"});return i.appendChild(s),{svg:i,groupNodes:o,groupFlows:a,groupLabels:s}}function R(t,l,e,i){for(let o of l.values()){if(!o.label.text){o.label.width=0,o.label.height=0;continue}let a=h("g",{id:`label-node-${o.idClean}`,class:O(o,i,"label")});t.appendChild(a);let s=h("text",{"font-size":`${e.fontsize}pt`});if(a.appendChild(s),typeof o.label.text=="string"){let d=o.label.text.split(`
`);for(let u of d){let f=h("tspan",{x:e.labelPadding,dy:"1.2em","font-size":`${e.fontsize}pt`});f.textContent=u,s.appendChild(f)}}let n=s.getBBox();o.label.width=n.width+2*e.labelPadding,o.label.height=n.height+2*e.labelPadding;let r=h("rect",{width:o.label.width,height:o.label.height,"font-size":`${e.fontsize}pt`});a.insertBefore(r,s)}}function k(t,l,e,i){let o=document.createElementNS(V,"style");o.textContent=`svg#${i.id}{
${X(i)}
${A(l,e)}}`,t.appendChild(o)}function I(t,l,e,i,o,a,s,n){let r=e.labelSpaceLeft+e.labelSpaceRight,d=(i-r-n.get(a)-e.margin[1]-e.margin[3])/a,u=(o-e.margin[0]-e.margin[2])/s;e.scaleX=d,e.scaleY=u;for(let f of t.values()){let m=f.x===0?0:(n.get(f.x)-f.width)/(f.x===a?1:2);f.x_=f.x*d+e.labelSpaceLeft+m+e.margin[1],f.y_=f.y*u+e.margin[0],f.size_=f.size*u}}function H(t,l,e,i,o,a,s,n,r,d,u=!1){u&&(l.innerHTML="",e.innerHTML="");let f=a.scaleX,m=a.scaleY;for(let c of i.values()){if(c.width>0&&c.size_>0){let Q=typeof c.tooltip=="function"?c.tooltip(c):c.tooltip===null?null:c.tooltip||`${c.label.text||""} (${c.size})`,U=h("rect",{id:`node-${c.idClean}`,x:c.x_,y:c.y_,width:c.width,height:c.size_,class:O(c,r,"node",c.className),"data-tooltip":Q});l.appendChild(U)}let p=t.getElementById(`label-node-${c.idClean}`);if(!p)continue;let C=c.y_+c.size_/2-c.label.height/2-a.fontsize*.3,x;c.label.position==="left"?x=c.x_-c.label.width:c.label.position==="right"?x=c.x_+c.width:x=c.x_+c.width/2-c.label.width/2,p.setAttribute("transform",`translate(${x}, ${C})`)}for(let c of o){let p=[c.className];c.value===0&&p.push("flowvalue-zero");let C=typeof c.tooltip=="function"?c.tooltip(c):c.tooltip===null?null:c.tooltip||`${i.get(c.from).label.text} &rarr; ${i.get(c.to).label.text}: ${c.value}`,x=h("path",{id:`flow-${c.idClean}`,class:p.join(" "),d:v(i,c,f,m),"data-tooltip":C});e.appendChild(x)}}function O(t,l,e,i=null){let o=[`${e}-column-${t.x}`];return t.x===l?o.push(`${e}-column-last`):t.x!==0&&o.push(`${e}-column-middle`),i&&o.push(i),o.join(" ")}var N="",y,it=window.innerWidth,lt=window.innerHeight;function j(t,l){let e=document.createElement("div");N=`${t}-tooltip`,e.setAttribute("id",N),e.setAttribute("style",`font-size:${l.fontsize}pt;background:#000;border-radius:5px;padding:5px;color:#fff;position:absolute;display:none;`),document.body.appendChild(e)}function W(){document.querySelectorAll("[data-tooltip]").forEach(t=>{let l=t.getAttribute("data-tooltip");l&&(t.addEventListener("mouseenter",st(l)),t.addEventListener("mousemove",rt()),t.addEventListener("mouseleave",at()))})}function P(){return document.getElementById(N)}function st(t){return()=>{let l=P();l.innerHTML=t,l.style.display="block",y=l.getBoundingClientRect()}}function rt(){return t=>{let l=P();y=l.getBoundingClientRect();let e=t.clientX+window.scrollX+10,i=t.clientY+window.scrollY+10;t.clientX+y.width+20>it&&(e=t.clientX+window.scrollX-y.width-10),t.clientY+y.height+20>lt&&(i=t.clientY+window.scrollY-y.height-10),l.style.left=e+"px",l.style.top=i+"px"}}function at(){return function(){let t=P();t.style.display="none"}}var E=t=>t.replaceAll(/[^\w\d]+/g,"");function q(t){let{flows:l,nodeConfig:e={},nodeBaseConfig:i={},flowBaseConfig:o={}}=t,a=new Set;l.forEach(n=>{Object.assign(n,o,n),n.value=Number(n.value||0),n.idClean=`${E(n.from)}-${E(n.to)}`,a.add(n.from),a.add(n.to)});let s=new Map;for(let n of a){let r={id:n,idClean:E(n),in:[],out:[],...i,...e[n],label:{...i?.label,...e[n]?.label}};s.set(n,r)}for(let n of l)s.get(n.from).out.push(n),s.get(n.to).in.push(n);for(let n of s.values())n.size=Math.max(n.in.reduce((r,d)=>r+d.value,0),n.out.reduce((r,d)=>r+d.value,0)),n.label.text=typeof n.label.text=="function"?n.label.text(n):n.label.text===null?null:n.label.text||n.id;return{nodes:s,flows:l}}var g,b=null,w,D=[],S,$,z,Z=t=>{let l=g.createSVGPoint();l.x=t.clientX,l.y=t.clientY;let e=l.matrixTransform(g.getScreenCTM()?.inverse());return{x:e.x,y:e.y}};function J(t,l,e,i,o){g=t;let a=g.querySelectorAll("rect[id^='node-']");for(let s of a)s.addEventListener("mousedown",n=>{n.preventDefault(),b=s;let r=Z(n),d=Number(s.getAttribute("x")),u=Number(s.getAttribute("y"));$={x:r.x-d,y:r.y-u};let f=b.getAttribute("id");if(S=[...l.values()].find(m=>m.idClean===f.replace("node-","")),w=g.getElementById(`label-${f}`),w){let m=w.getAttribute("transform").slice(10,-1).split(",").map(parseFloat);z={x:r.x-m[0],y:r.y-m[1]}}for(let m of S.in.concat(S.out)){let c=g.getElementById(`flow-${m.idClean}`);c&&(D.push({element:g.getElementById(`flow-${m.idClean}`),flow:m}),o.appendChild(c))}});document.addEventListener("mousemove",s=>{if(!b)return;let{x:n,y:r}=Z(s);S.x_=n-$.x,S.y_=r-$.y,b.setAttribute("x",String(n-$.x)),b.setAttribute("y",String(r-$.y)),w&&w.setAttribute("transform",`translate(${n-z.x}, ${r-z.y})`);for(let d of D)d.element.setAttribute("d",v(l,d.flow,e,i))}),document.addEventListener("mouseup",()=>{b=null})}var K=class{constructor(l,e){this.containerId=l;this.config=e;this.config.id=this.config.id??`${l}_`,this.config.padding??=20,this.config.labelPadding??=4,this.config.fontsize??=12,this.config.labelSpaceLeft??=0,this.config.labelSpaceRight??=0,this.config.margin??=[0,0,0,0],this.config.nodeBaseConfig??={},this.config.nodeBaseConfig.width??=20,this.config.flowBaseConfig??={},this.config.flowBaseConfig.render??="b",this.container=document.getElementById(l),this.container.innerHTML="",this.height=this.container.offsetHeight||500,this.width=this.container.offsetWidth||500;let{svg:i,groupNodes:o,groupFlows:a,groupLabels:s}=_(this.config,this.width,this.height);this.container.appendChild(i),j(l,this.config);let{nodes:n,flows:r}=q(this.config);this.nodes=n,this.flows=r,this.maxX=M(this.nodes,this.flows),this.maxY=F(this.nodes,this.maxX,this.config);let d=this.maxY/this.height*this.config.padding;this.maxY=Y(this.nodes,d,this.maxX),L(this.nodes),R(s,this.nodes,this.config,this.maxX),this.maxNodeWidth=T(this.nodes,this.config,this.maxX),k(i,this.nodes,this.flows,this.config),I(this.nodes,this.flows,this.config,this.width,this.height,this.maxX,this.maxY,this.maxNodeWidth),H(i,o,a,this.nodes,this.flows,this.config,this.width,this.height,this.maxX,this.maxY),W(),J(i,this.nodes,e.scaleX,e.scaleY,a)}};export{K as Sankey};
