function E(e,s){let t=new Set(e.keys()),i=0;for(;t.size;){let n=[];for(let r of t)e.get(r).in.map(f=>f.from).every(f=>e.get(f).x!==void 0)&&n.push(r);for(let r of n){let d=e.get(r);d.x=d.column||i,t.delete(r)}i++}let o=i-1,a=[...e.keys()],l=new Set(s.map(n=>n.from));return a.filter(n=>!l.has(n)).forEach(n=>{let r=e.get(n);r.x=r.column||o,o=Math.max(o,r.x)}),o}function z(e,s,t){let i=0,o=[...e.values()].sort((a,l)=>(a.sorting??0)-(l.sorting??0));for(let a=0;a<=s;a++){let l=0,n=o.filter(r=>r.x===a);for(let r of n){let d=r.relativeTo?.id,u=d?e.get(d):null;(!u||typeof u.y>"u")&&(u=null),u?r.y=u.y+(r.relativeTo.y1??0)*u.size+(r.relativeTo.y2??0)*r.size:r.y=l,l=r.y+r.size}i=Math.max(l,i)}return i}function M(e){for(let s of e.values()){let t=0;s.in.sort((i,o)=>e.get(i.from).y-e.get(o.from).y).forEach((i,o)=>{i.yOffsetTo=t,t+=i.value}),t=0,s.out.sort((i,o)=>e.get(i.to).y-e.get(o.to).y).forEach((i,o)=>{i.yOffsetFrom=t,t+=i.value})}}function F(e,s,t){let i=0,o=0,a=[...e.values()].sort((l,n)=>l.y-n.y);for(let l=0;l<=t;l++){let n=0,r=a.filter(d=>d.x===l);for(let d of r)d.relativeTo&&(n=0),d.paddings&&(n=d.paddings),d.y+=n*s,n+=1,i=Math.max(i,d.y+d.size),o=Math.min(o,d.y)}if(o<0)for(let l of e.values())l.y-=o;return i-o}function L(e,s,t){let i=new Map;for(let o of e.values()){let a=o.x;i.set(a,Math.max(i.get(a)??0,o.width));let l=o.label.position;if(o.label.position||(l=a===0?"left":a===t?"right":"center",o.label.position=l),a===0&&l!=="right"){let n=l==="center"?o.label.width*.5-o.width/2:o.label.width;s.labelSpaceLeft=Math.max(s.labelSpaceLeft??0,n)}else if(a===t&&l!=="left"){let n=l==="center"?o.label.width*.5-o.width/2:o.label.width;s.labelSpaceRight=Math.max(s.labelSpaceRight??0,n)}}return i}function B(e){return`rect[id^='node-']{fill:#777}
path[id^='flow-']{opacity:0.6;fill:#ddd;&:hover{opacity:1}}
path.flowvalue-zero{stroke:#ddd;stroke-width:1}
g[id^='label-node']{pointer-events:none;rect{fill:#fff}}
*{font-size:${e.fontsize}pt}`}function Y(e,s){let t="";for(let i of e.values()){let o=T(i.style);o&&(t+=`#node-${i.idClean} { ${o} }
`)}for(let i of s){let o=T(i.style);o&&(t+=`#flow-${i.idClean} { ${o} }
`)}return t}function T(e){if(e)return Object.entries(e).map(([s,t])=>`${s}:${t};`).join(" ")}function $(e,s,t,i){let o=e.get(s.from),a=e.get(s.to),l=s.value/2,n=l*i,r=o.y_+(l+s.yOffsetFrom)*i,d=a.y_+(l+s.yOffsetTo)*i,u=o.x_+o.width,f=a.x_;return s.render==="b"?U(f,d,u,r,n):tt({x:u,y:r},{x:u+t/2,y:r},{x:f-t/2,y:d},{x:f,y:d},n)}function U(e,s,t,i,o){let l=(t-e)/3,n={x:e,y:s-o},r={x:t,y:i-o},d={x:t,y:i+o},u={x:e,y:s+o},f={x:e+l,y:n.y},m={x:t-l,y:r.y},c={x:m.x,y:d.y},h={x:f.x,y:u.y};return`M ${n.x},${n.y}C ${f.x},${f.y} ${m.x},${m.y} ${r.x},${r.y}L ${d.x},${d.y}C ${c.x},${c.y} ${h.x},${h.y} ${u.x},${u.y}Z`}function tt(e,s,t,i,o,a=30){let l=[],n=[];for(let d=0;d<=a;d++){let u=d/a,f=et(u,e,s,t,i),m=ot(u,e,s,t,i);l.push(A(f,m,o)),n.unshift(A(f,m,-o))}let r=[];r.push(`M ${l[0].x},${l[0].y}`);for(let d=1;d<l.length;d++)r.push(`L ${l[d].x},${l[d].y}`);for(let d=0;d<n.length;d++)r.push(`L ${n[d].x},${n[d].y}`);return r.push("Z"),r.join(" ")}function et(e,s,t,i,o){let a=1-e;return{x:a**3*s.x+3*a**2*e*t.x+3*a*e**2*i.x+e**3*o.x,y:a**3*s.y+3*a**2*e*t.y+3*a*e**2*i.y+e**3*o.y}}function ot(e,s,t,i,o){let a=1-e,l={x:3*a**2*(t.x-s.x)+6*a*e*(i.x-t.x)+3*e**2*(o.x-i.x),y:3*a**2*(t.y-s.y)+6*a*e*(i.y-t.y)+3*e**2*(o.y-i.y)},n={x:-l.y,y:l.x},r=Math.sqrt(n.x*n.x+n.y*n.y);return r===0?{x:0,y:0}:{x:n.x/r,y:n.y/r}}function A(e,s,t){return{x:e.x+s.x*t,y:e.y+s.y*t}}var G="http://www.w3.org/2000/svg",p=(e,s)=>{let t=document.createElementNS(G,e);return Object.entries(s).forEach(([i,o])=>{o&&t.setAttribute(i,String(o))}),t};function V(e,s,t){let i=p("svg",{width:s,height:t,id:e.id}),o=p("g",{id:"nodes"});i.appendChild(o);let a=p("g",{id:"flows"});i.appendChild(a);let l=p("g",{id:"labels"});return i.appendChild(l),{svg:i,groupNodes:o,groupFlows:a,groupLabels:l}}function X(e,s,t,i){for(let o of s.values()){if(!o.label.text){o.label.width=0,o.label.height=0;continue}let a=p("g",{id:`label-node-${o.idClean}`,class:R(o,i,"label")});e.appendChild(a);let l=p("text",{"font-size":`${t.fontsize}pt`});if(a.appendChild(l),typeof o.label.text=="string"){let d=o.label.text.split(`
`);for(let u of d){let f=p("tspan",{x:t.labelPadding,dy:"1.2em","font-size":`${t.fontsize}pt`});f.textContent=u,l.appendChild(f)}}let n=l.getBBox();o.label.width=n.width+2*t.labelPadding,o.label.height=n.height+2*t.labelPadding;let r=p("rect",{width:o.label.width,height:o.label.height,"font-size":`${t.fontsize}pt`});a.insertBefore(r,l)}}function _(e,s,t,i){let o=document.createElementNS(G,"style");o.textContent=`svg#${i.id}{
${B(i)}
${Y(s,t)}}`,e.appendChild(o)}function k(e,s,t,i,o,a,l,n){let r=t.labelSpaceLeft+t.labelSpaceRight,d=(i-r-n.get(a)-t.margin[1]-t.margin[3])/a,u=(o-t.margin[0]-t.margin[2])/l;t.scaleX=d,t.scaleY=u;for(let f of e.values()){let m=f.x===0?0:(n.get(f.x)-f.width)/(f.x===a?1:2);f.x_=f.x*d+t.labelSpaceLeft+m+t.margin[1],f.y_=f.y*u+t.margin[0],f.size_=f.size*u}}function I(e,s,t,i,o,a,l,n,r,d,u=!1){u&&(s.innerHTML="",t.innerHTML="");let f=a.scaleX,m=a.scaleY;for(let c of i.values()){if(c.width>0&&c.size_>0){let K=typeof c.tooltip=="function"?c.tooltip(c):c.tooltip===null?null:c.tooltip||`${c.label.text||""} (${c.size})`,Q=p("rect",{id:`node-${c.idClean}`,x:c.x_,y:c.y_,width:c.width,height:c.size_,class:R(c,r,"node",c.className),"data-tooltip":K});s.appendChild(Q)}let h=document.getElementById(`label-node-${c.idClean}`);if(!h)continue;let v=c.y_+c.size_/2-c.label.height/2-a.fontsize*.3,x;c.label.position==="left"?x=c.x_-c.label.width:c.label.position==="right"?x=c.x_+c.width:x=c.x_+c.width/2-c.label.width/2,h.setAttribute("transform",`translate(${x}, ${v})`)}for(let c of o){let h=[c.className];c.value===0&&h.push("flowvalue-zero");let v=typeof c.tooltip=="function"?c.tooltip(c):c.tooltip===null?null:c.tooltip||`${i.get(c.from).label.text} &rarr; ${i.get(c.to).label.text}: ${c.value}`,x=p("path",{id:`flow-${c.idClean}`,class:h.join(" "),d:$(i,c,f,m),"data-tooltip":v});t.appendChild(x)}}function R(e,s,t,i=null){let o=[`${t}-column-${e.x}`];return e.x===s?o.push(`${t}-column-last`):e.x!==0&&o.push(`${t}-column-middle`),i&&o.push(i),o.join(" ")}var C="";function O(e,s,t){let i=document.createElement("div");C=`${e}-tooltip`,i.setAttribute("id",C),i.setAttribute("style",`font-size:${t.fontsize}pt;background:#000;border-radius:5px;padding:5px;color:#fff;position:absolute;display:none;`),s.parentNode.insertBefore(i,s),document.getElementById("tooltip")}function j(){document.querySelectorAll("[data-tooltip]").forEach(e=>{let s=e.getAttribute("data-tooltip");e.addEventListener("mousemove",nt(s)),e.addEventListener("mouseout",it())})}function H(){return document.getElementById(C)}function nt(e){return s=>{if(!e)return;let t=H();t.innerHTML=e,t.style.display="block",t.style.left=s.pageX+10+"px",t.style.top=s.pageY+10+"px"}}function it(){return function(e){let s=H();s.style.display="none"}}var N=e=>e.replaceAll(/[^\w\d]+/g,"");function W(e){let{flows:s,nodeConfig:t={},nodeBaseConfig:i={},flowBaseConfig:o={}}=e,a=new Set;s.forEach(n=>{Object.assign(n,o,n),n.value=Number(n.value||0),n.idClean=`${N(n.from)}-${N(n.to)}`,a.add(n.from),a.add(n.to)});let l=new Map;for(let n of a){let r={id:n,idClean:N(n),in:[],out:[],...i,...t[n],label:{...i?.label,...t[n]?.label}};l.set(n,r)}for(let n of s)l.get(n.from).out.push(n),l.get(n.to).in.push(n);for(let n of l.values())n.size=Math.max(n.in.reduce((r,d)=>r+d.value,0),n.out.reduce((r,d)=>r+d.value,0)),n.label.text=typeof n.label.text=="function"?n.label.text(n):n.label.text===null?null:n.label.text||n.id;return{nodes:l,flows:s}}var g,y=null,b,q=[],w,S,P,D=e=>{let s=g.createSVGPoint();s.x=e.clientX,s.y=e.clientY;let t=s.matrixTransform(g.getScreenCTM()?.inverse());return{x:t.x,y:t.y}};function Z(e,s,t,i,o){g=e;let a=g.querySelectorAll("rect[id^='node-']");for(let l of a)l.addEventListener("mousedown",n=>{n.preventDefault(),y=l;let r=D(n),d=Number(l.getAttribute("x")),u=Number(l.getAttribute("y"));S={x:r.x-d,y:r.y-u};let f=y.getAttribute("id");if(w=[...s.values()].find(m=>m.idClean===f.replace("node-","")),b=g.getElementById(`label-${f}`),b){let m=b.getAttribute("transform").slice(10,-1).split(",").map(parseFloat);P={x:r.x-m[0],y:r.y-m[1]}}for(let m of w.in.concat(w.out)){let c=g.getElementById(`flow-${m.idClean}`);c&&(q.push({element:g.getElementById(`flow-${m.idClean}`),flow:m}),o.appendChild(c))}});document.addEventListener("mousemove",l=>{if(!y)return;let{x:n,y:r}=D(l);w.x_=n-S.x,w.y_=r-S.y,y.setAttribute("x",String(n-S.x)),y.setAttribute("y",String(r-S.y)),b&&b.setAttribute("transform",`translate(${n-P.x}, ${r-P.y})`);for(let d of q)d.element.setAttribute("d",$(s,d.flow,t,i))}),document.addEventListener("mouseup",()=>{y=null})}var J=class{constructor(s,t){this.containerId=s;this.config=t;this.config.id=this.config.id??`${s}_`,this.config.padding??=20,this.config.labelPadding??=4,this.config.fontsize??=12,this.config.labelSpaceLeft??=0,this.config.labelSpaceRight??=0,this.config.margin??=[0,0,0,0],this.config.nodeBaseConfig??={},this.config.nodeBaseConfig.width??=20,this.config.flowBaseConfig??={},this.config.flowBaseConfig.render??="b",this.container=document.getElementById(s),this.container.innerHTML="",this.height=this.container.offsetHeight||500,this.width=this.container.offsetWidth||500;let{svg:i,groupNodes:o,groupFlows:a,groupLabels:l}=V(this.config,this.width,this.height);this.container.appendChild(i),O(s,this.container,this.config);let{nodes:n,flows:r}=W(this.config);this.nodes=n,this.flows=r,this.maxX=E(this.nodes,this.flows),this.maxY=z(this.nodes,this.maxX,this.config);let d=this.maxY/this.height*this.config.padding;this.maxY=F(this.nodes,d,this.maxX),M(this.nodes),X(l,this.nodes,this.config,this.maxX),this.maxNodeWidth=L(this.nodes,this.config,this.maxX),_(i,this.nodes,this.flows,this.config),k(this.nodes,this.flows,this.config,this.width,this.height,this.maxX,this.maxY,this.maxNodeWidth),I(i,o,a,this.nodes,this.flows,this.config,this.width,this.height,this.maxX,this.maxY),j(),Z(i,this.nodes,t.scaleX,t.scaleY,a)}};export{J as Sankey};
